<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Tomochika Hara">
  <title>thara</title>
  <link rel="stylesheet" href="https://thara.dev/css/main.css">
</head>
<body>
  <header>
    <h1>
      <a href="https://thara.dev">thara</a>
    </h1>
  </header>
  <div role="main">
    <div>
      <h1>Gunicorn起動中にUnixドメインソケットが消える</h1>
        <span>2017-07-06</span>
    </div>
    <article>
<p>会社のデベロッパーブログでも書いたけど再現手順は記載してなかったので、改めて。</p>
<p>Gunicorn 19.6.0 をthread workerで稼働していると、max_requestsに達してworker threadが再起動したときにUnixドメインソケットが削除される現象にあった。</p>
<p>以下、再現手順。   </p>
<h2 id="-">事前準備</h2>

<ul>
<li>Python 3.6</li>
<li><a href="https://github.com/h2o/h2o">h2o</a>  : Unixドメインソケット プロキシ用</li>
<li><a href="https://github.com/wg/wrk">wrk</a>  : ベンチマークツール</li>
</ul>

<pre><code>$ pip install gunicorn==19.6.0 bottle==0.12.13
</code></pre>
<p>以下のPythonモジュールを作成しておく。</p>
<p>web.py
(WSGIアプリケーション)</p>

<pre><code class="lang-python"># -*- coding:utf-8 -*-
from bottle import route, run, default_app

@route(&#39;/&#39;)
def index():
  return &#39;Hello World&#39;

app = default_app()
</code></pre>
<p>config.py
(gunicorn設定)</p>

<pre><code class="lang-python">bind = &#39;unix:/tmp/gunicorn.sock&#39;
backlog = 2048

workers = 5
threads = 5
worker_class = &#39;sync&#39;
worker_connections = 1000
timeout = 30
keepalive = 2

max_requests = 512

spew = False

daemon = False
pidfile = None
umask = 0
user = None
group = None
tmp_upload_dir = None

#   Logging
errorlog = &#39;-&#39;
loglevel = &#39;info&#39;
accesslog = &#39;-&#39;
access_log_format = &#39;%(h)s %(l)s %(u)s %(t)s &quot;%(r)s&quot; %(s)s %(b)s &quot;%(f)s&quot; &quot;%(a)s&quot;&#39;

# Process naming
proc_name = None

# Server hooks
def post_fork(server, worker):
    server.log.info(&quot;Worker spawned (pid: %s)&quot;, worker.pid)

def pre_fork(server, worker):
    pass

def pre_exec(server):
    server.log.info(&quot;Forked child, re-executing.&quot;)

def when_ready(server):
    server.log.info(&quot;Server is ready. Spawning workers&quot;)

def worker_int(worker):
    worker.log.info(&quot;worker received INT or QUIT signal&quot;)

    ## get traceback info
    import threading, sys, traceback
    id2name = dict([(th.ident, th.name) for th in threading.enumerate()])
    code = []
    for threadId, stack in sys._current_frames().items():
        code.append(&quot;\n# Thread: %s(%d)&quot; % (id2name.get(threadId,&quot;&quot;),
            threadId))
        for filename, lineno, name, line in traceback.extract_stack(stack):
            code.append(&#39;File: &quot;%s&quot;, line %d, in %s&#39; % (filename,
                lineno, name))
            if line:
                code.append(&quot;  %s&quot; % (line.strip()))
    worker.log.debug(&quot;\n&quot;.join(code))

def worker_abort(worker):
    worker.log.info(&quot;worker received SIGABRT signal&quot;)
</code></pre>
<p>h2o.conf
(h2o設定)</p>

<pre><code>listen:
  port: 18080
hosts:
  default:
    paths:
      &quot;/&quot;:
        proxy.reverse.url: http://[unix:/tmp/gunicorn.sock]/
        proxy.preserve-host: ON
    access-log: /dev/stdout
</code></pre>
<h2 id="-">サーバー起動</h2>
<p>gunicorn 起動</p>

<pre><code>$ gunicorn web:app -c config.py
</code></pre>
<p>h2o 起動</p>

<pre><code>$ h2o -c h2o.conf
</code></pre>
<h2 id="-">再現</h2>

<pre><code>$ wrk -t10 -c200 -d10s http://127.0.0.1:18080
</code></pre>
<p>以下のようなエラーログが出力される。<br>（場合によっては、スレッド数や接続数等のオプションを変更する必要があるかもしれない）</p>

<pre><code>[2017-02-18 01:26:57 +0900] [56927] [INFO] Autorestarting worker after current request.
 - - [18/Feb/2017:01:26:57 +0900] &quot;GET / HTTP/1.1&quot; 200 11 &quot;-&quot; &quot;-&quot;
 - - [18/Feb/2017:01:26:57 +0900] &quot;GET / HTTP/1.1&quot; 200 11 &quot;-&quot; &quot;-&quot;
 - - [18/Feb/2017:01:26:57 +0900] &quot;GET / HTTP/1.1&quot; 200 11 &quot;-&quot; &quot;-&quot;
[2017-02-18 01:26:57 +0900] [56927] [ERROR] Exception in worker process
Traceback (most recent call last):
  File &quot;/Users/thara/.pyenv/versions/3.6.0/envs/gunicorn_bug/lib/python3.6/site-packages/gunicorn/arbiter.py&quot;, line 557, in spawn_worker
    worker.init_process()
  File &quot;/Users/thara/.pyenv/versions/3.6.0/envs/gunicorn_bug/lib/python3.6/site-packages/gunicorn/workers/gthread.py&quot;, line 109, in init_process
    super(ThreadWorker, self).init_process()
  File &quot;/Users/thara/.pyenv/versions/3.6.0/envs/gunicorn_bug/lib/python3.6/site-packages/gunicorn/workers/base.py&quot;, line 132, in init_process
    self.run()
  File &quot;/Users/thara/.pyenv/versions/3.6.0/envs/gunicorn_bug/lib/python3.6/site-packages/gunicorn/workers/gthread.py&quot;, line 240, in run
    s.close()
  File &quot;/Users/thara/.pyenv/versions/3.6.0/envs/gunicorn_bug/lib/python3.6/site-packages/gunicorn/sock.py&quot;, line 123, in close
    os.unlink(self.cfg_addr)
FileNotFoundError: [Errno 2] No such file or directory: &#39;/tmp/gunicorn.sock&#39;
</code></pre>
<p>この状態になると、Unixドメインソケットのファイルが紛失するため、gunicornに対してリバースプロキシ（この例だとH2O）から接続できなくなり、
HTTPリクエストしたクライアントには502が返される。</p>
<p>該当issueは <a href="https://github.com/benoitc/gunicorn/issues/1298">これ</a>。<br>該当箇所は19.6.0での修正箇所であるため、19.6.0より前のバージョンではこの現象は発生しないと思われる。
また、このissueはすでに対応されcloseされているが、まだリリースには至っていない。</p>
<h2 id="-">回避方法</h2>
<p>現状では、Unixドメインソケットを使わず、portのlistenのみで対応するのが確実。</p>

    </article>
  </div>
  <footer>
    <small>
      <a href="https://thara.dev">Home</a>
      | <a href="https://github.com/thara/thara.github.io">GitHub</a>
      | <a href="https://thara.dev/about">About</a>
      | <a href="https://thara.dev/resume-ja">Resume(ja)</a>
      | &copy; 2021 Tomochika Hara
    </small>
  </footer>
</body>
</html>
