<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="thara">
  <meta name="Hatena::Bookmark" content="nocomment" />
  <link rel="stylesheet" href="https://thara.dev/css/main.css">
  <link rel="author" href="http://www.hatena.ne.jp/zetta1985/" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@zetta1985" />
  <meta name="twitter:title" content="GitHub API v4でレビューPRを一覧にするスクリプトを書いた | thara.dev" />
  <title>GitHub API v4でレビューPRを一覧にするスクリプトを書いた | thara.dev</title>
</head>
<body>
  <header>
    <h1>
      <a href="https://thara.dev">thara.dev</a>
    </h1>
  </header>
  <div role="main">
    <div>
      <h1>GitHub API v4でレビューPRを一覧にするスクリプトを書いた</h1>
      <span>2019-01-20</span>
    </div>
    <article>
    <p>レビュー対象のPRをサクッとCLIで確認したいなーと思い、 せっかくならGitHub API v4を使おうと思ってGraphQLクライアントを探したら、GitHub自体が <a href="https://github.com/github/graphql-client">github/graphql-client</a> というGraphQLクライアントを公開していたので、それを使ってみた。</p>
<p>実際のクエリを投げる前に、以下のようにHTTPクライアントの初期化やスキーマの読み込みが必要。</p>
<pre><code class="language-ruby">require 'graphql/client'
require 'graphql/client/http'

TOKEN = ENV['GITHUB_ACCESS_TOKEN']
ENDPOINT = 'https://api.github.com/graphql'

module GitHub
  HTTP = GraphQL::Client::HTTP.new(ENDPOINT) do
    def headers(context)
      {'Authorization': &quot;bearer #{TOKEN}&quot; }
    end
  end

  Schema = GraphQL::Client.load_schema(HTTP)

  Client = GraphQL::Client.new(schema: Schema, execute: HTTP)
end
</code></pre>
<p>ここでは、 <code>REVIEW</code> というラベルがつけられたPRをリポジトリごとに一覧する。</p>
<pre><code class="language-ruby">org = ARGV[0]

InReviewPullRequestQuery = GitHub::Client.parse &lt;&lt;-&quot;GRAPHQL&quot;
  query($org:String!) {
      organization(login: $org) {
      repositories(first: 100) {
        nodes {
          pullRequests(labels: &quot;REVIEW&quot;, states: [OPEN], first: 100, orderBy: {field: CREATED_AT, direction: DESC}) {
            edges {
              node {
                number
                title
                url
                repository {
                  nameWithOwner
                }
              }
            }
          }
        }
      }
    }
  }
GRAPHQL

result = GitHub::Client.query(InReviewPullRequestQuery, variables: {org: org})

prs = result.data.organization.repositories.nodes.flat_map(&amp;:pull_requests).flat_map(&amp;:edges).flat_map(&amp;:node)

repos = prs.group_by{|pr| pr.repository.name_with_owner}
repos.each do |repo_name, prs|
  puts &quot;- #{repo_name}&quot;
  prs.each do |pr|
    puts &quot;  - [#{pr.title} ##{pr.number}](#{pr.url})&quot;
  end
end
</code></pre>
<p>GraphQLのクエリを文字列で書いているところは、 <a href="https://developer.github.com/v4/explorer/">GraphQL API Explorer</a> で実際にクエリを投げて検証できる。
Variableとかも対応しているし、補完も効くので、とても使いやすい。</p>
<p>GraphQLは、cURLで手軽に動作確認できないだろうと今まで手をつけてなかったけど、 API Explorerみたいなのがあると簡単に動作確認できてDX良いな、と思った。</p>
<p>API Explorerで書いたクエリを共有するような機能があると、もっと捗りそう。</p>

    </article>
  </div>
  <footer>
  <small>
    <a href="https://thara.dev">Home</a>
    | <a href="https://github.com/thara/thara.github.io">GitHub</a>
    | <a href="https://thara.dev/about">About</a>
    | <a href="https://thara.dev/resume-ja">Resume(ja)</a>
    | &copy; 2023 thara
  </small>
</footer>
</body>
</html>

