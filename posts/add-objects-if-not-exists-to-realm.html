<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Tomochika Hara">
  <title>RealmSwiftでまだ存在しないオブジェクトだけを追加する - thara.dev</title>
  <link rel="stylesheet" type="text/css" href="https://thara.dev/css/neat.css">
  <link rel="stylesheet" type="text/css" href="https://thara.dev/css/custom.css">
  <meta name="og:title" content="RealmSwiftでまだ存在しないオブジェクトだけを追加する - thara.dev" />
  <meta name="og:type" content="article" />
  <meta name="og:site_name" content="thara.dev" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@zetta1985" />
  <meta name="twitter:title" content="RealmSwiftでまだ存在しないオブジェクトだけを追加する - thara.dev" />
  <meta name="Hatena::Bookmark" content="nocomment" />
  <link rel="author" href="http://www.hatena.ne.jp/zetta1985/" /></head>
<body>
  <header>
    <h1>RealmSwiftでまだ存在しないオブジェクトだけを追加する</h1>
    <ul>
      <li>published: <time>2018-10-22</time></li>
    </ul>
  </header>
  <div role="main">
    <article>
<p>RDBを使用したアプリケーションでよくあるパターンなんだけど、Realmではあまり例がなさそうだったので。</p>
<p>以下のモデルを例に取り上げる。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SampleObject<span class="op">:</span> <span class="dt">Object</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 略</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">static</span> <span class="kw">func</span> <span class="fu">primaryKey</span><span class="op">()</span> -&gt; <span class="fu">String</span>? <span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;identifier&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">// すでに保存されている/まだ保存されていないモデルが混在</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">objects</span><span class="op">:</span> <span class="op">[</span>SampleObject<span class="op">]</span> <span class="op">=</span> <span class="op">....</span></span></code></pre></div>
<h2 id="問題">問題</h2>
<ul>
<li>すでに保存されているRealmモデルとまだ保存されていないRealmモデルが混在するArrayがある</li>
<li>そのArrayのうち、まだ保存されていないRealmモデルだけをRealmに新規追加したい</li>
<li>すでに保存されているRealmモデルのプロパティを更新したくない</li>
<li>少ないデータアクセス回数で抑えたい</li>
</ul>
<p><code>Realm#add</code>
には複数オブジェクトを渡すことができるが、引数<code>update</code>をtrueにするとobjects内の「すでに保存されているRealmモデル」が更新されてしまい、falseにするとidentifierの値が重複するためエラーが発生する。</p>
<pre><code>realm.add(objects, update: true)  // すでに保存されているRealmモデルが更新される
realm.add(objects, update: false) // identifierの値が重複するためエラー</code></pre>
<h2 id="解決方法">解決方法</h2>
<p>ポイントは「すでに保存されているRealmモデルのキー」がわかれば「まだ保存されていないRealmモデル」が分かる、ということ。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// すべてのprimaryKeyのArray</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">keys</span> <span class="op">=</span> objects<span class="op">.</span>map <span class="op">{</span> $<span class="fl">0.</span>identifier <span class="op">}</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">// すでに保存されているRealmモデルを取得して、そのprimaryKeyのSetを得る</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">storedKeys</span> <span class="op">=</span> Set<span class="op">(</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    realm<span class="op">.</span>objects<span class="op">(</span>SampleObject<span class="op">.</span><span class="kw">self</span><span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>filter<span class="op">(</span><span class="st">&quot;identifier IN %@&quot;</span><span class="op">,</span> keys<span class="op">).</span>map <span class="op">{</span> $<span class="fl">0.</span>identifier <span class="op">})</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">// すでに保存されているRealmモデルのprimaryKeyに一致しないオブジェクトを選択する</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">newObjects</span> <span class="op">=</span> objects<span class="op">.</span>filter <span class="op">{</span> <span class="op">!</span>storedKeys<span class="op">.</span>contains<span class="op">(</span>$<span class="fl">0.</span>identifier<span class="op">)</span> <span class="op">}</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> newObjects<span class="op">.</span>count <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> realm<span class="op">.</span>write <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// newObjectsはまだ保存されていないRealmモデルのみなので update: false</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        realm<span class="op">.</span>add<span class="op">(</span>newObjects<span class="op">,</span> update<span class="op">:</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>効率的にデータアクセスするために以下の2点の工夫を入れている。</p>
<ul>
<li>「すでに保存されているRealmモデルのキー」を一度のデータアクセスで取得する</li>
<li>「すでに保存されているRealmモデルのキー」を
<code>Set</code>にすることで<code>contains</code>の計算量をO(1)にする</li>
</ul>
<p>「すでに保存されているRealmモデル」の数が多い場合は、より効果的になる。</p>
    </article>
  </div>
<footer>
  <small>
    <a href="https://thara.dev">thara.jp</a>
    | &copy; 2025 Tomochika Hara
  </small></footer>
</body>
</html>
