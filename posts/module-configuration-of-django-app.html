<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Tomochika Hara">
  <title>中規模Djangoアプリケーションのモジュール構成 - thara.dev</title>
  <link rel="stylesheet" type="text/css" href="https://thara.dev/css/neat.css">
  <link rel="stylesheet" type="text/css" href="https://thara.dev/css/custom.css">
  <meta name="og:title" content="中規模Djangoアプリケーションのモジュール構成 - thara.dev" />
  <meta name="og:type" content="article" />
  <meta name="og:site_name" content="thara.dev" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@zetta1985" />
  <meta name="twitter:title" content="中規模Djangoアプリケーションのモジュール構成 - thara.dev" />
  <meta name="Hatena::Bookmark" content="nocomment" />
  <link rel="author" href="http://www.hatena.ne.jp/zetta1985/" /></head>
<body>
  <header>
    <h1>中規模Djangoアプリケーションのモジュール構成</h1>
    <ul>
      <li>published: <time>2016-12-09</time></li>
    </ul>
  </header>
  <div role="main">
    <article>
<p>DjangoやRuby on
Railsといったフルスタックフレームワークは、シンプルなCRUDアプリケーションを素早く構築することができるが、複雑なアプリケーションの設計をどうすればよいかという問題にはいつも悩まされる。</p>
<p>どのようなプロジェクトによるかはケースバイケースだが、自分の中でおおよそ固まってきたので、それをまとめてみる。</p>
<p>Djangoの場合、フレームワークが必要とするモジュールはsettings.pyとmodels.pyぐらいなので、各Djangoアプリケーション内では割と自由にモジュールを定義できる。</p>
<p>自分は以下のような自作モジュールを配置するようにしている。</p>
<ul>
<li>commands</li>
<li>query</li>
<li>services</li>
<li>utils</li>
</ul>
<h3 id="commands">commands</h3>
<p>まずは、command。このcommandはGoFのCommandパターンのことではなく、Command-Query
Responsibility SegregationのCommand。<br />
つまり、更新系のオペレーションのこと。
このモジュールには、更新用の関数とその関数用の引数/戻り値（入力/出力）用ののDTOが含まれ、viewsから直接使用される。
このモジュールの更新用関数は、DBのトランザクション境界とおおよそ一致する。</p>
<p>大体以下のような感じ。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> namedtuple</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>UserProfileUpdateCommand <span class="op">=</span> namedtuple(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;UserUpdateCommand&quot;</span>, <span class="st">&quot;user_id user_name email_address&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfileUpdateResult(namedtuple(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;UserProfileUpdateResult&quot;</span>, <span class="st">&quot;success errors&quot;</span>)):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> to_dict(<span class="va">self</span>):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;success&quot;</span>: <span class="va">self</span>.success, <span class="st">&quot;errors&quot;</span>: <span class="va">self</span>.errors}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _validate_command(command: UserProfileUpdateCommand):</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot; commandに指定された値のプロパティ検証 &quot;&quot;&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_user_profile(command: UserProfileUpdateCommand):</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot; 更新系処理 &quot;&quot;&quot;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    errors <span class="op">=</span> _validate_command(command)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> errors:</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> UserProfileUpdateResult(success<span class="op">=</span><span class="va">False</span>, errors<span class="op">=</span>errors)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> transaction.atomic():</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        user_profile <span class="op">=</span> UserProfile.objects.get(command.user_id)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        user_profile.user_name <span class="op">=</span> command.user_name</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        user_profile.email_address <span class="op">=</span> command.email_address</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        user_profile.save(</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>            update_fields<span class="op">=</span>[<span class="st">&#39;user_name&#39;</span>, <span class="st">&#39;email_address&#39;</span>])</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> UserProfileUpdateResult(success<span class="op">=</span><span class="va">True</span>, errors<span class="op">=</span>[])    </span></code></pre></div>
<p><code>_validate_command</code>
は、上の例のようにシンプルな更新であれば<code>UserProfile</code>のメソッドとして提供してもよいかもしれない。<br />
が、modelを更新する機能が複数ある場合は検証処理もそれによって異なることがあるので、そのような検証処理はcommandに定義した方がいいだろう。<br />
また、commandでmodelの<code>save</code>メソッドを直接呼ぶのも良いが、複数の機能から同じような更新処理を実行するのであれば、modelにメソッドを実装するのも悪くない。</p>
<p>これらの関数/クラス
はViewから以下のように使われる。（RESTｆrameworkを使用を前提としている）</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfileView(APIView):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> post(<span class="va">self</span>, request):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> UserProfileUpdateSerializer(data<span class="op">=</span>request.data)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        s.is_valid(raise_exception<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        command <span class="op">=</span> UserProfileUpdateCommand(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            user_id<span class="op">=</span>serializer.validated_data[<span class="st">&#39;user_id&#39;</span>],</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            user_name<span class="op">=</span>serializer.validated_data[<span class="st">&#39;user_name&#39;</span>],</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>            email_address<span class="op">=</span>serializer.validated_data[<span class="st">&#39;email_address&#39;</span>])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> update_user_profile(command)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Response(result.to_dict(), status<span class="op">=</span>status.HTTP_200_OK)</span></code></pre></div>
<h3 id="query">query</h3>
<p>queryは、commandと対照的に、viewsから使用される参照系の関数を定義する。</p>
<pre><code>def get_user_profile(user_id):
    return UserProfile.objects.using(&#39;read_replica&#39;).get(user_id)</code></pre>
<p>この例だとあまり利点は見えないが、DBリードレプリカを参照したり、キャッシュからデータを取ってくるなど、パフォーマンス優先の実装を配置するのに最適。</p>
<h2 id="services--utils">services / utils</h2>
<p>このserviceとは、レイヤードアーキテクチャのサービス層ともDDDのドメインサービスとも関係がない。
services.pyには、viewsからは直接使用されないが、同じDjangoアプリケーション内のcommandsやquery、または異なるDjangoアプリケーションから使用される関数やクラスを定義する。</p>
<p>一方のutilsは、あらゆるアプリケーションから使用される可能性があるユーティリティ関数を定義する。
こちらは極力、Djangoなどのフレームワークに依存しないことが望ましい。</p>
<h2 id="djangoアプリケーションの構成">Djangoアプリケーションの構成</h2>
<p>ここまで挙げた、 commands, query, services,
utilsを、機能を表すパッケージごとに定義する。</p>
<p>以下は一例。</p>
<p>より実際のファイル構成に近くなるよう、フレームワークの使用にあたって必要になるであろうファイルも配置した。</p>
<p>models.py, views.py, urls.pyはそれぞれDjangoのDBモデル, View,
URLディスパッチ設定。serializers.pyはDjango
RESTframework用のJSONシリアライズ設定。</p>
<pre><code>sns_sample
├── friend
│   ├── request
│   │   ├── commands.py
│   │   ├── query.py
│   │   ├── serializers.py
│   │   └── services.py
│   ├── commands.py
│   ├── models.py
│   ├── query.py
│   ├── serializers.py
│   ├── serivces.py
│   ├── urls.py
│   └── views.py
└── user
    ├── login
    │   ├── commands.py
    │   ├── serializers.py
    │   └── services.py
    ├── signup
    │   ├── commands.py
    │   ├── serializers.py
    │   └── utils.py
    ├── models.py
    ├── serializers.py
    ├── urls.py
    └── views.py</code></pre>
<p>だいたいこんな感じ。
それほど複雑になるわけでもなく、かといって不足もないようなちょうどよい塩梅だと思う。もちろん、プロジェクトの規模にもよるのだが、中規模であれば、これぐらいで良いだろう。</p>
<p>実際のモジュール配置場所を決定するために一番考えなければいけないことは、モジュール構成を変更するのはかなりリスキーである、ということを認識すること。</p>
<p>バージョン管理システムによるソースコードのバージョン管理もファイルの配置場所を変えるとうまくいかないことが多いため、今までのソースコードの変更履歴を追うのがめんどくさくなる。</p>
<p>よりシンプルでわかりやすい構成にしておくことを心掛けたい。</p>
    </article>
  </div>
<footer>
  <small>
    <a href="https://thara.dev">thara.jp</a>
    | &copy; 2025 Tomochika Hara
  </small></footer>
</body>
</html>
