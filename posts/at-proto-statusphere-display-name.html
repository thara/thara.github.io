<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Tomochika Hara">
  <title>AT Protocolアプリにdisplay
name表示機能を追加する - thara.dev</title>
  <link rel="stylesheet" type="text/css" href="https://thara.dev/css/neat.css">
  <link rel="stylesheet" type="text/css" href="https://thara.dev/css/custom.css">
  <meta name="og:title" content="AT Protocolアプリにdisplay
name表示機能を追加する - thara.dev" />
  <meta name="og:type" content="article" />
  <meta name="og:site_name" content="thara.dev" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@zetta1985" />
  <meta name="twitter:title" content="AT Protocolアプリにdisplay
name表示機能を追加する - thara.dev" />
  <meta name="Hatena::Bookmark" content="nocomment" />
  <link rel="author" href="http://www.hatena.ne.jp/zetta1985/" /></head>
<body>
  <header>
    <h1>AT Protocolアプリにdisplay name表示機能を追加する</h1>
    <div class="timestamp">
      <small>published: <time>2026-01-11</time> </small>
    </div>
  </header>
  <div role="main">
    <article>
<p><a href="./at_proto_quickstart.html">前回の記事</a>でAT
Protocolのチュートリアルを一通り完了したので、今度は<a
href="https://atproto.com/guides/applications">Quick start
guide</a>のNext Stepsセクションにある「Sync the profile records of all
users so that you can show their display names instead of their
handles」を実装してみた。</p>
<p>実装内容は<a
href="https://github.com/thara/statusphere-example-app/pull/6">これ</a>。</p>
<h2 id="解決策-write-time-caching">解決策: Write-time caching</h2>
<p>今回は、ステータス投稿（書き込み）時に、その投稿者のプロフィール情報を取得してローカルに保存するアプローチを採用した。</p>
<p>表示の即時性を優先しつつ、実装の複雑さを最小限に抑えるのが狙い。</p>
<h3 id="実装の流れ">実装の流れ</h3>
<p>src/routes.ts - POST /status ハンドラー内</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ステータス投稿後、プロフィールを取得してキャッシュ</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> profileResponse <span class="op">=</span> <span class="cf">await</span> agent<span class="op">.</span><span class="at">com</span><span class="op">.</span><span class="at">atproto</span><span class="op">.</span><span class="at">repo</span><span class="op">.</span><span class="fu">getRecord</span>({</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  repo<span class="op">:</span> agent<span class="op">.</span><span class="at">assertDid</span><span class="op">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  collection<span class="op">:</span> <span class="st">&#39;app.bsky.actor.profile&#39;</span><span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  rkey<span class="op">:</span> <span class="st">&#39;self&#39;</span><span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 取得したプロフィール情報をSQLiteにキャッシュ</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> ctx<span class="op">.</span><span class="at">db</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">insertInto</span>(<span class="st">&#39;profile&#39;</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">values</span>({</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    did<span class="op">:</span> agent<span class="op">.</span><span class="at">assertDid</span><span class="op">,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    displayName<span class="op">:</span> record<span class="op">.</span><span class="at">displayName</span> <span class="op">||</span> <span class="dt">null</span><span class="op">,</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">onConflict</span>((oc) <span class="kw">=&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    oc<span class="op">.</span><span class="fu">column</span>(<span class="st">&#39;did&#39;</span>)<span class="op">.</span><span class="fu">doUpdateSet</span>({</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>      displayName<span class="op">:</span> record<span class="op">.</span><span class="at">displayName</span> <span class="op">||</span> <span class="dt">null</span><span class="op">,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">execute</span>()</span></code></pre></div>
<p>これにより、投稿直後にすぐに表示名が表示されるようになる。エラーが起きてもステータス投稿自体は失敗させないようにエラーハンドリングも入っている。</p>
<h3 id="実装の詳細">実装の詳細</h3>
<h4 id="データベーススキーマ">データベーススキーマ</h4>
<p>新しくprofileテーブルを追加。マイグレーションは起動時に自動実行される:</p>
<p>src/db.ts</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">export type</span> Profile <span class="op">=</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  did<span class="op">:</span> <span class="dt">string</span>              <span class="co">// Primary key</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  displayName<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  description<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  avatarCid<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  avatarMimeType<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  bannerCid<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  bannerMimeType<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  indexedAt<span class="op">:</span> <span class="dt">string</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">export type</span> DatabaseSchema <span class="op">=</span> {</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  status<span class="op">:</span> Status</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  profile<span class="op">:</span> Profile  <span class="co">// 追加</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  auth_session<span class="op">:</span> AuthSession</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  auth_state<span class="op">:</span> AuthState</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><a href="https://kysely.dev/">Kysely</a>
を使ったのは初めてだったけど、まぁ他のORMと似た感じなので特に問題なく使えた。</p>
<h4 id="表示ロジック">表示ロジック</h4>
<p>homeページではstatusテーブルとprofileテーブルをLEFT
JOINして、表示名を取得:</p>
<p>src/routes.ts</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> statusesWithProfiles <span class="op">=</span> <span class="cf">await</span> ctx<span class="op">.</span><span class="at">db</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">selectFrom</span>(<span class="st">&#39;status&#39;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">leftJoin</span>(<span class="st">&#39;profile&#39;</span><span class="op">,</span> <span class="st">&#39;status.authorDid&#39;</span><span class="op">,</span> <span class="st">&#39;profile.did&#39;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;status.uri&#39;</span><span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;status.authorDid&#39;</span><span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;status.status&#39;</span><span class="op">,</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;profile.displayName&#39;</span><span class="op">,</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">execute</span>()</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> statuses <span class="op">=</span> statusesWithProfiles<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> ({</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  uri<span class="op">:</span> row<span class="op">.</span><span class="at">uri</span><span class="op">,</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  authorDid<span class="op">:</span> row<span class="op">.</span><span class="at">authorDid</span><span class="op">,</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  status<span class="op">:</span> row<span class="op">.</span><span class="at">status</span><span class="op">,</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  displayName<span class="op">:</span> row<span class="op">.</span><span class="at">displayName</span> <span class="op">||</span> <span class="dt">null</span><span class="op">,</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>}))</span></code></pre></div>
<p>フロントエンドでは、表示名がある場合は「DisplayName
(@handle)」、ない場合は「@handle」という形式で表示:</p>
<p>src/pages/home.ts</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> displayName <span class="op">=</span> status<span class="op">?.</span><span class="at">displayName</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authorDisplay <span class="op">=</span> displayName</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">?</span> <span class="fu">html</span><span class="vs">`</span><span class="sc">${</span>displayName<span class="sc">}</span><span class="vs"> &lt;span class=&quot;handle&quot;&gt;(@</span><span class="sc">${</span>handle<span class="sc">}</span><span class="vs">)&lt;/span&gt;`</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">:</span> <span class="fu">html</span><span class="vs">`@</span><span class="sc">${</span>handle<span class="sc">}</span><span class="vs">`</span></span></code></pre></div>
<h2 id="lexiconとスキーマ定義">Lexiconとスキーマ定義</h2>
<p>AT Protocolでは、データ構造を <a
href="https://atproto.com/specs/lexicon">Lexicon</a>
というスキーマ定義言語で定義する。今回使った <a
href="https://github.com/bluesky-social/atproto/blob/main/lexicons/app/bsky/actor/profile.json">app.bsky.actor.profile</a>
もLexiconで定義されている。</p>
<p>チュートリアルアプリのxyz.statusphere.statusは独自のLexiconスキーマで、lexicons/ディレクトリに定義されている。npm
run lexgenコマンドでTypeScriptの型定義が自動生成される:</p>
<p>lexicons/status.json</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;lexicon&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;xyz.statusphere.status&quot;</span><span class="fu">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;defs&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;record&quot;</span><span class="fu">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;tid&quot;</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;record&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;object&quot;</span><span class="fu">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;required&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;status&quot;</span><span class="ot">,</span> <span class="st">&quot;createdAt&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;string&quot;</span><span class="fu">,</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;minLength&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;maxGraphemes&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;maxLength&quot;</span><span class="fu">:</span> <span class="dv">32</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">},</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;string&quot;</span><span class="fu">,</span> <span class="dt">&quot;format&quot;</span><span class="fu">:</span> <span class="st">&quot;datetime&quot;</span> <span class="fu">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>src/routes.ts</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> Status <span class="im">from</span> <span class="st">&#39;#/lexicon/types/xyz/statusphere/status&#39;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> record <span class="op">=</span> {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  $type<span class="op">:</span> <span class="st">&#39;xyz.statusphere.status&#39;</span><span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  status<span class="op">:</span> req<span class="op">.</span><span class="at">body</span><span class="op">?.</span><span class="at">status</span><span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  createdAt<span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">// バリデーション</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>Status<span class="op">.</span><span class="fu">validateRecord</span>(record)<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>この仕組みにより、型安全性を保ちながら柔軟なデータ構造を定義できる。<br />
ここら辺は自分で開発する際もよくProtocolBuffersスキーマとか使うので、似たような感覚で使えそう。</p>
<h2
id="分散型プロトコルならではの課題">分散型プロトコルならではの課題</h2>
<p>今回の実装を通して、「分散型プロトコル上でアプリケーションを作るときの前提」が、これまで慣れてきたWebアプリケーションとは大きく異なると感じた。</p>
<p>特に印象的だったのは、<strong>自分が管理していないユーザーのデータが、自然に流れ込んでくる</strong>
こと。</p>
<p>今回の実装では、一旦UI上の課題に対応する目的で複雑なキャッシュ戦略ではなく「投稿時にプロフィールをフェッチする」というシンプルなアプローチを採用した。しかし、これだと以下の問題がある。</p>
<ul>
<li>投稿していないユーザーのdisplay nameの更新が反映されない</li>
<li>DBに保存されていないユーザーのdisplay nameが表示されない</li>
</ul>
<p>後者については説明が必要かもしれない。</p>
<p>チュートリアルアプリでは <code>xyz.statusphere.status</code>
コレクションでステータス投稿しているが、このコレクションはAT
Protocol上の全ユーザーが投稿できる。つまり、他の人が投稿したステータスが自分のローカルで起動しているチュートリアルアプリに届く可能性がある。</p>
<p>今回の実装では、<strong>ステータス投稿時にそのユーザーのプロフィールをキャッシュする</strong>仕組みを入れたため、他の人の手元で投稿されたステータスの投稿者プロフィールは自分のローカルDBにキャッシュされない。</p>
<p>今までのアプリケーション開発の発想だと当たり前なのだが、分散型プロトコル上で動作するアプリケーションでは、<strong>自分が管理しているデータ以外にも他のユーザーのデータが届く可能性がある</strong>
という点が新しい発想だった。</p>
<p>なので、次回はこの課題を解決に挑戦したい。</p>
<p>実は、初期の実装ではFirehoseでプロフィール更新イベント(<code>app.bsky.actor.profile</code>)
を監視してキャッシュする実装にしていた。しかし、これだとAT
Protocol上の全てのユーザーのプロフィール更新が送られてくるため、負荷が高くなる可能性があったのでやめた。</p>
<p>これを踏まえて、次は以下の2つのアプローチを検証してみる予定。</p>
<ul>
<li><code>xyz.statusphere.status</code> に display name
を含めるようにスキーマを拡張する</li>
<li>ステータス投稿イベント監視時に、その投稿者のプロフィールを取得してキャッシュする</li>
</ul>
<h2 id="参考リンク">参考リンク</h2>
<ul>
<li><a
href="https://atproto.com/guides/applications">https://atproto.com/guides/applications</a></li>
<li><a
href="https://atproto.com/specs/repository">https://atproto.com/specs/repository</a></li>
<li><a
href="https://atproto.com/specs/lexicon">https://atproto.com/specs/lexicon</a></li>
<li><a
href="https://github.com/thara/statusphere-example-app/pull/6">https://github.com/thara/statusphere-example-app/pull/6</a></li>
</ul>
    </article>
  </div>
<footer>
  <small>
    <a href="https://thara.dev">thara.jp</a>
    | &copy; 2026 Tomochika Hara
  </small></footer>
</body>
</html>
